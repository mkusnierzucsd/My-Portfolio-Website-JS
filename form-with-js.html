<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="description" content="Form built with JS">
        <title>Form with JS</title>
        <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
        
        <style>
            :root {
                --my-header-color: rgb(84, 178, 212);
                --my-header-color-dark: rgb(7, 1, 176);
                --light-background-color: rgb(169, 233, 231);
                --dark-background-color: color(from black srgb 0.07451 0.121568 0.129412);
            }
            body {
                font-family: Arial, Helvetica, sans-serif;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 2rem;
            }

            form {
                background: white;
                border: 1px solid lightslategray;
                border-radius: 10px;
                padding: 2rem;
                max-width: 400px;
                width: 100%;
                display: flex;
                flex-direction: column;
            }

            fieldset {
                border: none;
                padding: 0;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            legend {
                font-size: 1.3rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
            }

            label {
                display: block;
                font-weight: bold;
                margin-bottom: 0.25rem;
            }

            input, textarea {
                font-size: 1rem;
                padding: 0.6rem;
                border-radius: 5px;
                border: 1px solid grey;
                width: 95%;
                transition: 0.3s ease-in-out;
            }

            button {
                width: 100%;
                transition: 0.3s ease-in-out;
                font-size: 1rem;
                padding: 0.6rem;
                border: 1px solid cornflowerblue;
                border-radius: 8px;
            }

            input:focus, textarea:focus {
                outline: 2px solid blue;
                border-color: blue;
            }

            input:invalid:not(:focus),
            textarea:invalid:not(:focus) {
                outline: 2px solid red;
                border-color: red;
            }

            button {
                background-color: cornflowerblue;
                color: white;
                font-weight: bold;
                cursor: pointer;
            }

            button:hover {
                background-color: blue;
            }      

            output {
                font-size: 0.9em;
                min-height: 1em;
            }

            output[for="error"] {
                color: red;
            }

            output[for="info"] {
                color: black;
            }

            label[for]:has(+ input[required])::after,
            label[for]:has(+ textarea[required])::after {
                content: " *";
                color: #b00020;
            }

            .hidden {
                display: none;
            }
            

        </style>
        
    </head>
    <body>
        <form action="https://httpbin.org/post" method="post" id="testform">
            <fieldset id="ctest" name="ctest">
                <legend>Contact Me</legend>
                <label for="name">Name</label>
                <input type="text" name="name" id="name" minlength="3" pattern="[A-Za-z\s'\-]+" autofocus required>
                <output class="hidden" for="error" id="name-error"></output>
                <output for="info" id="name-info">Enter at least 3 characters. Letters, spaces, apostrophes, and hyphens allowed.</output>
                <label for="email">Email</label>
                <input type="email" name="email" id="email" inputmode="email" required>
                <output class="hidden" for="error" id="email-error"></output>
                <output for="info" id="email-info">Enter a valid email address (example: name@example.com).</output>
                <label for="message">Message</label>
                <textarea id="message" name="message" rows="5" cols="33" maxlength="500" required></textarea>
                <output class="hidden" for="error" id="message-error"></output>
                <output for="info" id="message-info"></output>
                <input type="hidden" name="possible_bot" value="true">
                <input type="hidden" name="form-errors" id="form-errors">
                <button>Submit</button>
            </fieldset>
        </form>
        <label class="switch">
            Light/Dark Mode Toggle
            <input type="checkbox" id="themeToggle" onclick="toggleTheme()">
            <span class="slider"></span>
        </label>
    </body>
    <script>
        const form_errors= [];
        function storeError(fieldId, message, value) {
            form_errors.push({
                field: fieldId,
                message: message,
                value_entered: value
            });
        }


        const nameInput = document.getElementById("name");
        const allowedName = /^[A-Za-z\s'\-]+$/;
        const emailInput = document.getElementById("email");
        const allowedEmail = /^[A-Za-z0-9\.@\-]+$/;

        function showError(input, message) {
            const errorOutput = document.getElementById(input.id + "-error");
            errorOutput.textContent = message;
            errorOutput.classList.remove("hidden");
            input.classList.add("flash");


            setTimeout(() => {
                errorOutput.classList.add("hidden");
                input.classList.remove("flash");
            }, 2000);
        }

        function enforceNameRules(event) {
            if (!allowedName.test(event.target.value)) {
                const msg = "Invalid character entered.";
                showError(event.target, msg);
                event.target.value = event.target.value.replace(/[^A-Za-z\s'\-]/g, "");
                storeError("name",msg,nameInput.value);
                nameInput.setCustomValidity("");
            }
            nameInput.setCustomValidity("");
        }

        function enforceEmailRules(event) {
            if (!allowedEmail.test(event.target.value)) {
                const msg = "Invalid character entered.";
                showError(event.target, msg);
                event.target.value = event.target.value.replace(/[^A-Za-z0-9\.@\-]/g, "");
                storeError("email",msg,emailInput.value);
                emailInput.setCustomValidity("");
            }
            emailInput.setCustomValidity("");
        }

        nameInput.addEventListener("input", enforceNameRules);


        nameInput.addEventListener("input", (event) => {
            if(!nameInput.checkValidity()) {
                nameInput.setCustomValidity("Please enter at least 3 characters. Please do not enter numbers or special characters");
            } else {
                nameInput.setCustomValidity("");
            }
        });

        emailInput.addEventListener("input", enforceEmailRules);

        emailInput.addEventListener("input", (event) => {
            if (!emailInput.checkValidity()) {
                emailInput.setCustomValidity("Must be a valid email address");
            } else {
                emailInput.setCustomValidity("");
            }
        });

        const message = document.getElementById("message");
        const messageError = document.getElementById("message-error");
        const messageInfo = document.getElementById("message-info");

        message.addEventListener("input", (event) => {
            const length = message.value.length;
            const maxLength = message.maxLength;

            messageInfo.textContent = `${length}/${maxLength} characters.`; 

            if(length < maxLength) {
                messageError.classList.add("hidden");
            }
            

            if(length >= 0.75 * maxLength && length < maxLength) {
                message.style.outline = "2px solid orange";
                message.style.borderColor = "orange";
            }

            if(length >= maxLength) {
                message.style.outline = "2px solid red";
                message.style.borderColor = "red";
                const msg = "You have reached the character limit.";
                messageError.textContent = msg; 
                messageError.classList.remove("hidden");
                storeError("message",msg,message.value);
            }

            if(!message.checkValidity()) {
                message.setCustomValidity("Your message should be anywhere between 1 and 500 characters");
            } else {
                message.setCustomValidity("");
            }
        });

        const form = document.querySelector("form");

        form.addEventListener("submit", (e) => {
            const encoded = JSON.stringify(form_errors);
            document.getElementById("form-errors").value = encoded;
        });
    </script>
    <script src="src/script.js"></script>
</html>